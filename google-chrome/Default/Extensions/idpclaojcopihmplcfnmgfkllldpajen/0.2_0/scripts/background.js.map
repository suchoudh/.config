{"version":3,"sources":["scripts/background.js"],"names":["PROTOCOL","DOMAIN_GNOTES","DOMAIN_SUIBIJI","DOMAIN","localStorage","getItem","chrome","i18n","getMessage","SITE_DOMAIN","SITE_API_HOST_V2","getCookies","success","fail","cookies","get","url","name","cookie","updateDomain","initInfoFromServer","callback","originSetting","initDomain","upgradeMenu","setItem","isGnotes","runtime","onInstalled","addListener","details","browserAction","onClicked","tab","start","data","action","_","tabs","sendMessage","id","res","login","domain","e","f","windows","create","width","height","type","top","Math","round","max","screen","availHeight","left","availWidth","b","tabId","onUpdated","changeInfo","remove","update","menuId","genericOnClick","info","title","contextMenus","contexts","onclick"],"mappings":"AAAA,YAEA,IAAIA,UAAW,WACXC,cAAgB,YAChBC,eAAiB,cACjBC,OAASC,aAAaC,QAAQ,WAAaC,OAAOC,KAAKC,WAAW,iBAClEC,YAAc,GACdC,iBAAmB,GAEnBC,WAAa,SAAoBC,EAASC,GAC1CP,OAAOQ,QAAQC,KACXC,IAAOhB,SAAWG,OAClBc,KAAQ,KACT,SAAUC,GACHA,GACFC,eACAP,GAAWA,KAEXC,GAAQA,OAKhBO,mBAAqB,SAA4BC,EAAUR,GAC3D,GAAIS,GAAgBnB,MACpBQ,YAAWU,EAAU,WAEjBlB,OAASmB,GAAiBrB,cAAgBC,eAAiBD,cAC3DU,WAAWU,EAAU,WACjBlB,OAASmB,EACTH,eACAN,GAAQA,EAAKJ,kBAKrBc,WAAa,WACbd,YAAcT,SAAWG,OAAS,IAClCO,iBAAmBV,SAAWG,OAAS,WAGvCgB,aAAe,WACfI,aACAC,aAAeA,cACfpB,aAAaqB,QAAQ,SAAUtB,QAC/BC,aAAaqB,QAAQ,aAAcf,kBACnCN,aAAaqB,QAAQ,cAAehB,cAGpCiB,SAAW,WACX,MAAOvB,UAAWF,cAGtBsB,cAEAjB,OAAOqB,QAAQC,YAAYC,YAAY,SAAUC,GAChDV,uBAKDd,OAAOyB,cAAcC,UAAUH,YAAY,SAAUI,GACpDC,OAAQD,IAAKA,KAId,IAAIC,OAAQ,SAAeC,GAC1BA,EAAKC,OAAS,YACdhB,mBAAmB,SAAUiB,GAC5B/B,OAAOgC,KAAKC,YAAYJ,EAAKF,IAAIO,IAAMJ,OAAUD,GAAQ,SAAUM,OACjEC,QAGAA,MAAQ,SAAeC,GAC1B,GAAIC,GAAI,IACJC,EAAI,GACRvC,QAAOwC,QAAQC,QACd/B,IAAK,cACLgC,MAAOJ,EACPK,OAAQJ,EACRK,KAAM,QACNC,IAAKC,KAAKC,MAAMD,KAAKE,IAAIC,OAAOC,YAAcX,EAAG,GAAK,GACtDY,KAAML,KAAKC,MAAMD,KAAKE,IAAIC,OAAOG,WAAad,EAAG,GAAK,IACpD,SAAUe,GACZ,GAAIC,GAAQD,EAAErB,KAAK,GAAGE,EACtBlC,QAAOgC,KAAKuB,UAAUhC,YAAY,SAAUW,EAAIsB,EAAY7B,GACvD2B,GAASpB,GAAMsB,EAAW9C,KAAO2B,GACpCrC,OAAOgC,KAAKyB,OAAOH,KAGrBtD,OAAOgC,KAAK0B,OAAOJ,GAClB5C,IAAK2B,EAAS,uDAMbsB,OAAS,KACTC,eAAiB,SAAwBC,EAAMlC,GAClDC,OAAQiC,KAAMA,EAAMlC,IAAKA,KAGtBT,YAAc,WACjB,GAAI4C,GAAQ1C,WAAa,gBAAkB,QACvCuC,QACH3D,OAAO+D,aAAaL,OAAOC,QAC1BG,MAASA,GACP,SAAU3B,MAEbwB,OAAS3D,OAAO+D,aAAatB,QAC5BqB,MAASA,EACTE,UAAa,OACbC,QAAWL,iBAKd1C","file":"background.js","sourcesContent":["'use strict';\n\nvar PROTOCOL = 'https://';\nvar DOMAIN_GNOTES = 'gnotes.me';\nvar DOMAIN_SUIBIJI = 'suibiji.com';\nvar DOMAIN = localStorage.getItem('domain') || chrome.i18n.getMessage(\"defaultDomain\"),\n    SITE_DOMAIN = '',\n    SITE_API_HOST_V2 = '';\n\nvar getCookies = function getCookies(success, fail) {\n    chrome.cookies.get({\n        \"url\": PROTOCOL + DOMAIN,\n        \"name\": 't'\n    }, function (cookie) {\n        if (!!cookie) {\n            updateDomain();\n            success && success();\n        } else {\n            fail && fail();\n        }\n    });\n};\n\nvar initInfoFromServer = function initInfoFromServer(callback, fail) {\n    var originSetting = DOMAIN;\n    getCookies(callback, function () {\n        // 第一次取 cookie 失败，再取另一个域名的 cookie\n        DOMAIN = originSetting == DOMAIN_GNOTES ? DOMAIN_SUIBIJI : DOMAIN_GNOTES;\n        getCookies(callback, function () {\n            DOMAIN = originSetting;\n            updateDomain();\n            fail && fail(SITE_DOMAIN);\n        });\n    });\n};\n\nvar initDomain = function initDomain() {\n    SITE_DOMAIN = PROTOCOL + DOMAIN + '/';\n    SITE_API_HOST_V2 = PROTOCOL + DOMAIN + '/api/v2';\n};\n\nvar updateDomain = function updateDomain() {\n    initDomain();\n    upgradeMenu && upgradeMenu();\n    localStorage.setItem('domain', DOMAIN);\n    localStorage.setItem('domain_api', SITE_API_HOST_V2);\n    localStorage.setItem('site_domain', SITE_DOMAIN);\n};\n\nvar isGnotes = function isGnotes() {\n    return DOMAIN === DOMAIN_GNOTES;\n};\n\ninitDomain();'use strict';\n\nchrome.runtime.onInstalled.addListener(function (details) {\n\tinitInfoFromServer();\n});\n\n// chrome.browserAction.setBadgeText({text: '\\'Allo'});\n\nchrome.browserAction.onClicked.addListener(function (tab) {\n\tstart({ tab: tab });\n});\n\n// check & login or open\nvar start = function start(data) {\n\tdata.action = 'openFrame';\n\tinitInfoFromServer(function (_) {\n\t\tchrome.tabs.sendMessage(data.tab.id, { 'action': data }, function (res) {});\n\t}, login);\n};\n\nvar login = function login(domain) {\n\tvar e = 610,\n\t    f = 710;\n\tchrome.windows.create({\n\t\turl: 'about:blank',\n\t\twidth: e,\n\t\theight: f,\n\t\ttype: 'popup',\n\t\ttop: Math.round(Math.max(screen.availHeight - f, 0) / 2),\n\t\tleft: Math.round(Math.max(screen.availWidth - e, 0) / 2)\n\t}, function (b) {\n\t\tvar tabId = b.tabs[0].id;\n\t\tchrome.tabs.onUpdated.addListener(function (id, changeInfo, tab) {\n\t\t\tif (tabId == id && changeInfo.url == domain) {\n\t\t\t\tchrome.tabs.remove(tabId);\n\t\t\t}\n\t\t});\n\t\tchrome.tabs.update(tabId, {\n\t\t\turl: domain + 'user#/login?channel=chrome_extension_open_panel'\n\t\t});\n\t});\n};\n\n// contextMenu\nvar menuId = null;\nvar genericOnClick = function genericOnClick(info, tab) {\n\tstart({ info: info, tab: tab });\n};\n\nvar upgradeMenu = function upgradeMenu() {\n\tvar title = isGnotes() ? 'Add To GNotes' : \"添加到随笔记\";\n\tif (menuId) {\n\t\tchrome.contextMenus.update(menuId, {\n\t\t\t\"title\": title\n\t\t}, function (res) {});\n\t} else {\n\t\tmenuId = chrome.contextMenus.create({\n\t\t\t\"title\": title,\n\t\t\t\"contexts\": ['all'],\n\t\t\t\"onclick\": genericOnClick\n\t\t});\n\t}\n};\n\nupgradeMenu();"]}